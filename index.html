<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QUEERZ! MC Companion - Redesigned</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- APP HEADER -->
    <header class="app-header">
        <div class="header-top">
            <h1>QUEERZ! MC Companion</h1>
            <div class="header-controls">
                <button class="header-btn" id="toggleScriptBtn" title="Toggle Script Panel (S)">üìñ Script</button>
                <button class="header-btn" id="toggleMcMovesBtn" title="Toggle MC Moves (M)">üé≤ MC Moves</button>
                <button class="header-btn" id="campaignSettingsBtn" title="Campaign Settings">‚öôÔ∏è Settings</button>
                <button class="header-btn" id="sessionMgmtBtn" title="Session Management">üíæ Sessions</button>
                <button class="header-btn" id="exportCampaignBtn" title="Export Campaign Progress">üì§ Export</button>
            </div>
        </div>
        <div class="campaign-info">
            <label for="campaignSelect">Campaign:</label>
            <select class="styled-select" id="campaignSelect">
                <option value="">Select Campaign...</option>
            </select>

            <label for="arcSelect">Arc:</label>
            <select class="styled-select" id="arcSelect">
                <option value="arc-1">Arc 1</option>
                <option value="arc-2">Arc 2</option>
                <option value="arc-3">Arc 3</option>
            </select>

            <label for="chapterSelect">Chapter:</label>
            <select class="styled-select" id="chapterSelect">
                <option value="1">Chapter 1</option>
            </select>
        </div>
    </header>

    <!-- SPOTLIGHT BAR -->
    <section class="spotlight-bar">
        <div class="spotlight-label">SPOTLIGHT:</div>
        <div class="spotlight-players" id="spotlightPlayers">
            <button class="player-btn add-btn" id="addPlayerBtn">+ Add Player</button>
        </div>
    </section>

    <!-- MAIN CONTENT AREA -->
    <main class="main-content">
        <!-- BROADCAST PANEL (Full Width) -->
        <section class="panel broadcast-panel">
            <div class="panel-header">
                <h3>üé¨ Broadcast to Players</h3>
                <button class="header-btn broadcast-btn" id="broadcastAllBtn">üì° Broadcast All</button>
            </div>
            <div class="broadcast-grid">
                <!-- Environment -->
                <div class="broadcast-section">
                    <h4>üåÜ Environment</h4>
                    <select class="styled-select" id="environmentSelect">
                        <option value="">Select Environment...</option>
                        <option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/locations/cafe-greenwich.jpg" value="cafe-greenwich">Cafe Greenwich</option>
                        <option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/locations/theater-district.jpg" value="theater-district">Theater District</option>
                        <option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/locations/morettis-comedy-cellar.webp" value="morettis">Moretti's Comedy Cellar</option>
                    </select>
                    <div class="broadcast-display" id="environmentDisplay">
                        <div class="placeholder-text">Select an environment</div>
                    </div>
                </div>

                <!-- NPC Profile -->
                <div class="broadcast-section">
                    <h4>üë§ NPC Profile</h4>
                    <select class="styled-select" id="npcSelect">
                        <option value="">Select NPC...</option>
                        <option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/mama-jay-portrait.png" value="mama-jay">Mama Jay Rainbow</option>
                        <option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/danny-civilian.png" value="danny-civilian">Danny Carbone</option>
                        <option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/danny-justice-knight.png" value="danny-justice">Danny "The Jester"</option>
                        <option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/pawn-tough-crowd-general.png" value="pawn">Tough Crowd Pawn</option>
                    </select>
                    <div class="broadcast-display" id="npcDisplay">
                        <div class="placeholder-text">Select an NPC</div>
                    </div>
                </div>

                <!-- Music Player -->
                <div class="broadcast-section">
                    <h4>üéµ Music</h4>
                    <select class="styled-select" id="musicSelect">
                        <option value="">Select Music...</option>
                        <optgroup label="Locations">
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/cafe-greenwich-1.mp3">Cafe Greenwich 1</option>
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/cafe-greenwich-2.mp3">Cafe Greenwich 2</option>
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/theater-district-investigation-1.mp3">Theater District 1</option>
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/theater-district-investigation-2.mp3">Theater District 2</option>
                        </optgroup>
                        <optgroup label="Boss Battles">
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/danny-battle-1.mp3">Danny Battle 1</option>
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/danny-battle-2.mp3">Danny Battle 2</option>
                        </optgroup>
                        <optgroup label="Emotional Themes">
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/emotional-themes/inner-space-theme-1.mp3">Inner Space 1</option>
                            <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/emotional-themes/inner-space-theme-2.mp3">Inner Space 2</option>
                        </optgroup>
                    </select>
                    <div class="player-controls">
                        <button class="control-btn" id="playMusicBtn">‚ñ∂Ô∏è</button>
                        <button class="control-btn" id="pauseMusicBtn">‚è∏Ô∏è</button>
                        <button class="control-btn" id="stopMusicBtn">‚èπÔ∏è</button>
                        <button class="control-btn" id="loopMusicBtn" title="Loop">üîÅ</button>
                        <button class="control-btn" id="addPlaylistBtn" title="Add to Playlist">‚ûï</button>
                    </div>
                    <div class="now-playing" id="nowPlaying">No track playing</div>
                    <div class="playlist hidden" id="playlistContainer">
                        <h4>Playlist</h4>
                        <div id="playlistTracks"></div>
                    </div>
                    <audio id="audioPlayer"></audio>
                </div>
            </div>
        </section>

        <!-- PLAYER TAG MANAGEMENT PANEL -->
        <section class="panel">
            <div class="panel-header">
                <h3>üè∑Ô∏è Player Tags</h3>
                <button class="header-btn" id="playerOverviewBtn">üë• All Players</button>
            </div>
            <div id="playerTagsContainer">
                <p class="placeholder-text">Select a player from the spotlight to manage tags</p>
            </div>
        </section>

        <!-- CAMPAIGN PROGRESS PANEL -->
        <section class="panel">
            <div class="panel-header">
                <h3>‚úÖ Campaign Progress</h3>
                <div style="display: flex; gap: 10px;">
                    <button class="header-btn" id="addCheckpointBtn">+ Add Checkpoint</button>
                    <button class="header-btn" id="clearCheckpointsBtn" style="background: rgba(232, 155, 155, 0.3);">Clear All</button>
                </div>
            </div>
            <div class="progress-section" id="progressContainer">
                <p class="placeholder-text">No checkpoints yet. Add story checkpoints to track progress!</p>
            </div>
        </section>

        <!-- COMBAT ENCOUNTER COUNTERS -->
        <section class="panel">
            <div class="panel-header">
                <h3>‚öîÔ∏è Encounter Counters</h3>
            </div>

            <!-- Ignorance Limit Counter -->
            <div class="counter-section">
                <div class="counter-header">
                    <h4>Ignorance Limit</h4>
                    <button class="counter-btn reset" onclick="resetCounter('ignorance')">Reset</button>
                </div>
                <div class="counter-display">
                    <div class="counter-value" id="ignoranceCounter">0</div>
                </div>
                <div class="counter-controls">
                    <button class="counter-btn decrement" onclick="changeCounter('ignorance', -1)">‚àí</button>
                    <button class="counter-btn increment" onclick="changeCounter('ignorance', 1)">+</button>
                </div>
            </div>
        </section>

        <!-- DICE ROLLER -->
        <section class="panel dice-roller">
            <h4>üé≤ Dice Roller</h4>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <label for="moveName" style="font-weight: 600;">Move:</label>
                <input type="text" id="moveName" placeholder="Enter move name (optional)"
                       style="flex: 1; padding: 8px; background: rgba(30, 30, 50, 0.8); border: 2px solid rgba(103, 232, 249, 0.3); color: #F5EFE6; border-radius: 8px; font-size: 1rem;">
            </div>
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                <label for="powerModifier" style="font-weight: 600;">Power Modifier:</label>
                <input type="number" id="powerModifier" value="0" min="-5" max="5"
                       style="width: 80px; padding: 8px; background: rgba(30, 30, 50, 0.8); border: 2px solid rgba(103, 232, 249, 0.3); color: #F5EFE6; border-radius: 8px; font-size: 1.1rem; text-align: center; font-weight: bold;">
            </div>
            <button class="roll-btn" id="rollDiceBtn">Roll 2d6</button>
            <div class="dice-display">
                <div class="dice-formula">
                    <div class="die1" id="die1">?</div>
                    <span style="color: #F5EFE6;">+</span>
                    <div class="die2" id="die2">?</div>
                    <span style="color: #F5EFE6;">+</span>
                    <div id="modDisplay" style="color: #F4D35E; font-size: 1.5rem;">?</div>
                    <span style="color: #F5EFE6;">=</span>
                    <div id="totalDisplay" style="color: #4ADE80; font-size: 1.8rem; font-weight: bold;">?</div>
                </div>
                <div class="roll-result" id="rollResult"></div>
            </div>
        </section>
    </main>

    <!-- MOVES BAR -->
    <section class="moves-bar">
        <div class="moves-label">Core Moves:</div>
        <div class="move-icons">
            <div class="move-icon" title="Be Vulnerable">
                <img src="images/icons/moves/move-be-vulnerable.png" alt="Be Vulnerable">
            </div>
            <div class="move-icon" title="Care">
                <img src="images/icons/moves/move-care.png" alt="Care">
            </div>
            <div class="move-icon" title="Get a Clue">
                <img src="images/icons/moves/move-get-a-clue.png" alt="Get a Clue">
            </div>
            <div class="move-icon" title="Resist">
                <img src="images/icons/moves/move-resist.png" alt="Resist">
            </div>
            <div class="move-icon" title="Slay">
                <img src="images/icons/moves/move-slay.png" alt="Slay">
            </div>
            <div class="move-icon" title="Strike a Pose">
                <img src="images/icons/moves/move-strike-a-pose.png" alt="Strike a Pose">
            </div>
            <div class="move-icon" title="Talk It Out">
                <img src="images/icons/moves/move-talk-it-out.png" alt="Talk It Out">
            </div>
        </div>
    </section>

    <!-- SCRIPT PANEL (Slide-in from right) -->
    <aside class="side-panel hidden" id="scriptPanel">
        <div class="panel-header-side">
            <h3 id="scriptPanelTitle">Campaign Script</h3>
            <button class="close-panel-btn" id="closeScriptBtn">√ó</button>
        </div>
        <div class="panel-search">
            <input type="text" class="search-input" id="scriptSearch" placeholder="Search script...">
        </div>
        <div class="panel-tabs" id="scriptTabs">
            <!-- Tabs will be dynamically loaded -->
        </div>
        <div class="panel-content" id="scriptContent">
            <!-- Content will be dynamically loaded -->
        </div>
    </aside>

    <!-- MC MOVES PANEL (Slide-in from right) -->
    <aside class="side-panel hidden" id="mcMovesPanel">
        <div class="panel-header-side">
            <h3>MC Moves Reference</h3>
            <button class="close-panel-btn" id="closeMcMovesBtn">√ó</button>
        </div>
        <div class="panel-content">
            <div class="moves-section">
                <h4>Soft Moves</h4>
                <div class="move-item">
                    <strong>Show signs of trouble</strong>
                    <p>Foreshadow danger or complications approaching</p>
                </div>
                <div class="move-item">
                    <strong>Offer an opportunity</strong>
                    <p>Present a chance with a cost or complication</p>
                </div>
                <div class="move-item">
                    <strong>Tell them the cost</strong>
                    <p>Make the price clear before they commit</p>
                </div>
                <div class="move-item">
                    <strong>Put someone in a spot</strong>
                    <p>Force a difficult decision or dilemma</p>
                </div>
                <div class="move-item">
                    <strong>Present Twisted Justice</strong>
                    <p>Show the villain's narrow-minded worldview</p>
                </div>
            </div>
            <div class="moves-section">
                <h4>Hard Moves (On 6- or ignored threat)</h4>
                <div class="move-item">
                    <strong>Deal harm</strong>
                    <p>Inflict damage or consequences</p>
                </div>
                <div class="move-item">
                    <strong>Turn their move back on them</strong>
                    <p>Use their action against them</p>
                </div>
                <div class="move-item">
                    <strong>Separate them</strong>
                    <p>Split the party or isolate someone</p>
                </div>
                <div class="move-item">
                    <strong>Make a construct move</strong>
                    <p>Use villain's construct abilities</p>
                </div>
                <div class="move-item">
                    <strong>Take away their stuff</strong>
                    <p>Remove resources or advantages</p>
                </div>
                <div class="move-item">
                    <strong>Make them buy</strong>
                    <p>Force them to accept a cost immediately</p>
                </div>
                <div class="move-item">
                    <strong>Give a status</strong>
                    <p>Apply a negative condition (conforming, shaken, etc.)</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- PLAYER MODAL -->
    <div class="modal hidden" id="playerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Player to Spotlight</h2>
                <button class="close-modal-btn" id="closePlayerModalBtn">√ó</button>
            </div>
            <p style="margin-bottom: 15px;">Enter player name:</p>
            <input type="text" class="text-input" id="playerNameInput" placeholder="Player name...">
            <div class="modal-buttons">
                <button class="btn-primary" id="confirmPlayerBtn">Add Player</button>
                <button class="btn-secondary" id="cancelPlayerBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- PLAYER OVERVIEW MODAL -->
    <div class="modal hidden" id="playerOverviewModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>Player Overview & Tags</h2>
                <button class="close-modal-btn" id="closePlayerOverviewBtn">√ó</button>
            </div>
            <div id="playerOverviewContent">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- CHECKPOINT MODAL -->
    <div class="modal hidden" id="checkpointModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Story Checkpoint</h2>
                <button class="close-modal-btn" id="closeCheckpointModalBtn">√ó</button>
            </div>
            <p style="margin-bottom: 10px;">Checkpoint description:</p>
            <input type="text" class="text-input" id="checkpointInput" placeholder="e.g., Players discovered Moretti's Comedy Cellar">
            <p style="margin-top: 15px; margin-bottom: 10px;">Next chapter to load (optional):</p>
            <select class="styled-select" id="checkpointNextChapter" style="width: 100%;">
                <option value="">Don't change chapter</option>
                <option value="2">Chapter 2</option>
                <option value="3">Chapter 3</option>
                <option value="4">Chapter 4</option>
                <option value="5">Chapter 5</option>
            </select>
            <div class="modal-buttons">
                <button class="btn-primary" id="confirmCheckpointBtn">Add Checkpoint</button>
                <button class="btn-secondary" id="cancelCheckpointBtn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- SESSION MANAGEMENT MODAL -->
    <div class="modal hidden" id="sessionModal">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h2>Session Management</h2>
                <button class="close-modal-btn" id="closeSessionModalBtn">√ó</button>
            </div>
            <div>
                <h3 style="color: #F4D35E; margin-bottom: 15px;">Current Session: <span id="currentSessionName">Default Session</span></h3>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="header-btn" onclick="saveCurrentSession()">üíæ Save Session</button>
                    <button class="header-btn" onclick="saveSessionAs()">üìù Save As New</button>
                </div>
                <hr style="border-color: rgba(74, 124, 126, 0.3); margin: 20px 0;">
                <h3 style="color: #E89B9B; margin-bottom: 15px;">Saved Sessions</h3>
                <div id="sessionList"></div>
            </div>
        </div>
    </div>

    <!-- CAMPAIGN SETTINGS MODAL -->
    <div class="modal hidden" id="campaignSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Campaign Settings</h2>
                <button class="close-modal-btn" id="closeCampaignSettingsBtn">√ó</button>
            </div>
            <div>
                <h3 style="color: #F4D35E; margin-bottom: 15px;">Story Outcomes</h3>
                <p style="margin-bottom: 15px;">Track major story decisions for future chapters:</p>
                <div id="outcomesContainer">
                    <!-- Outcomes will be populated based on current campaign -->
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase Config & Broadcast -->
    <script type="module" src="firebase-config.js"></script>
    <script type="module" src="firebase-broadcast.js"></script>
    <script type="module" src="campaign-manager-mc.js"></script>

    <!-- Main App Script -->
    <script type="module" src="app.js"></script>

    <!-- Image Display Handlers -->
    <script>
        // Handle image display for environment, NPC, and music selects
        document.addEventListener('DOMContentLoaded', function() {
            const environmentSelect = document.getElementById('environmentSelect');
            const npcSelect = document.getElementById('npcSelect');
            const environmentDisplay = document.getElementById('environmentDisplay');
            const npcDisplay = document.getElementById('npcDisplay');

            function displayImage(selectElement, displayElement) {
                const selected = selectElement.options[selectElement.selectedIndex];
                const imgUrl = selected.dataset.img;

                if (imgUrl) {
                    displayElement.innerHTML = `<img src="${imgUrl}" alt="${selected.textContent}" style="width: 100%; height: 100%; object-fit: contain;">`;
                } else {
                    displayElement.innerHTML = `<div class="placeholder-text">Select ${selectElement.id === 'environmentSelect' ? 'an environment' : 'an NPC'}</div>`;
                }
            }

            environmentSelect?.addEventListener('change', () => displayImage(environmentSelect, environmentDisplay));
            npcSelect?.addEventListener('change', () => displayImage(npcSelect, npcDisplay));
        });
    </script>
</body>
</html>
