<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>QUEERZ! MC Companion</title>
<link href="styles.css" rel="stylesheet"/>
</head>
<body>
<!-- TOP HEADER -->
<header class="app-header">
<h1>QUEERZ! MC Companion</h1>
<div class="campaign-info">
<label for="chapterSelect">Chapter:</label>
<select class="styled-select" id="chapterSelect">
<option value="1">Chapter 1: The Jester's Last Laugh</option>
<option value="2">Chapter 2: The Professor's Prescription</option>
<option value="3">Chapter 3: The Champion's Last Stand</option>
<option value="4">Chapter 4: The Mogul's Empire</option>
<option value="5">Chapter 5: The Titan's Domain</option>
</select>
<button class="header-btn" id="campaignSettingsBtn" title="Campaign Settings">‚öôÔ∏è</button> <button class="header-btn" id="sessionMgmtBtn" title="Session Management">üíæ Sessions</button> <button class="header-btn" id="playerOverviewBtn" title="Player Overview">üë• Players</button> <button class="header-btn" id="broadcastBtn" title="Broadcast to Players">üì° Broadcast</button>
</div>
<div class="header-controls">
<button class="header-btn" id="toggleScriptBtn" title="Toggle Script Panel (S)">Script</button>
<button class="header-btn" id="toggleMcMovesBtn" title="Toggle MC Moves (M)">MC Moves</button>
</div>
</header>
<!-- SPOTLIGHT BAR -->
<section class="spotlight-bar">
<div class="spotlight-label">SPOTLIGHT:</div>
<div class="spotlight-players" id="spotlightPlayers">
<button class="player-btn add-btn" id="addPlayerBtn">+ Add Player</button>
</div>
</section>
<!-- MAIN CONTENT AREA -->
<main class="main-content">
<!-- LEFT PANEL: Scene/Location Display -->
<section class="scene-panel">
<div class="panel-header">
<h3>Location</h3>
<select class="styled-select" id="locationSelect">
<option value="">Select Location...</option>
<option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/locations/cafe-greenwich.jpg" value="cafe-greenwich">Cafe Greenwich</option>
<option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/locations/theater-district.jpg" value="theater-district">Theater District</option>
<option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/locations/morettis-comedy-cellar.webp" value="morettis">Moretti's Comedy Cellar</option>
</select>
</div>
<div class="scene-display" id="sceneDisplay">
<div class="placeholder-text">Select a location to display</div>
</div>
</section>
<!-- RIGHT PANEL: Character Sheet (when spotlighted) or NPC Display -->
<section class="character-panel">
<div class="panel-header">
<h3 id="characterPanelTitle">Character/NPC</h3>
<select class="styled-select" id="characterSelect">
<option value="">Select Character...</option>
<option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/mama-jay-portrait.png" value="mama-jay">Mama Jay Rainbow</option>
<option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/danny-civilian.png" value="danny-civilian">Danny Carbone (Civilian)</option>
<option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/danny-justice-knight.png" value="danny-justice">Danny "The Jester" (Justice Knight)</option>
<option data-img="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/images/characters/pawn-tough-crowd-general.png" value="pawn">Tough Crowd (Pawn)</option>
</select>
</div>
<!-- Character Sheet Display (Visible to Players when spotlighted) -->
<div class="character-sheet-display hidden" id="characterSheetDisplay">
<!-- Active player's character sheet shows here -->
</div>
<!-- NPC/Character Portrait Display -->
<div class="character-display" id="characterDisplay">
<div class="placeholder-text">Select a character to display</div>
</div>
<div class="character-info" id="characterInfo"></div>
</section>
</main>
<!-- MOVE ICONS BAR - YOUR CUSTOM ICONS WITH CORRECT PATHS -->
<section class="moves-bar">
<div class="moves-label">Core Moves:</div>
<div class="move-icons">
<div class="move-icon" title="Be Vulnerable">
<img alt="Be Vulnerable" src="images/icons/moves/move-be-vulnerable.png"/>
</div>
<div class="move-icon" title="Care">
<img alt="Care" src="images/icons/moves/move-care.png"/>
</div>
<div class="move-icon" title="Get a Clue">
<img alt="Get a Clue" src="images/icons/moves/move-get-a-clue.png"/>
</div>
<div class="move-icon" title="Resist">
<img alt="Resist" src="images/icons/moves/move-resist.png"/>
</div>
<div class="move-icon" title="Slay">
<img alt="Slay" src="images/icons/moves/move-slay.png"/>
</div>
<div class="move-icon" title="Strike a Pose">
<img alt="Strike a Pose" src="images/icons/moves/move-strike-a-pose.png"/>
</div>
<div class="move-icon" title="Talk It Out">
<img alt="Talk It Out" src="images/icons/moves/move-talk-it-out.png"/>
</div>
</div>
</section>
<!-- BOTTOM CONTROLS -->
<footer class="bottom-controls">
<!-- MUSIC PLAYER - COMPLETE 18-TRACK LIBRARY -->
<div class="music-player">
<h4>Music</h4>
<select class="styled-select" id="trackSelect">
<option value="">Select Track...</option>
<optgroup label="Locations">
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/cafe-greenwich-1.mp3">Cafe Greenwich 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/cafe-greenwich-2.mp3">Cafe Greenwich 2</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/theater-district-investigation-1.mp3">Theater District Investigation 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/theater-district-investigation-2.mp3">Theater District Investigation 2</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/university-1.mp3">University 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/locations/university-2.mp3">University 2</option>
</optgroup>
<optgroup label="Boss Battles">
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/danny-battle-1.mp3">Danny Battle 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/danny-battle-2.mp3">Danny Battle 2</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/pierce-battle-1.mp3">Pierce Battle 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/pierce-battle-2.mp3">Pierce Battle 2</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/rex-battle-1.mp3">Rex Battle 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/rex-battle-2.mp3">Rex Battle 2</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/victoria-battle-1.mp3">Victoria Battle 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/victoria-battle-2.mp3">Victoria Battle 2</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/marcus-battle-1.mp3">Marcus Battle 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/boss-battles/marcus-battle-2.mp3">Marcus Battle 2</option>
</optgroup>
<optgroup label="Emotional Themes">
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/emotional-themes/inner-space-theme-1.mp3">Inner Space Theme 1</option>
<option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/emotional-themes/inner-space-theme-2.mp3">Inner Space Theme 2</option>
</optgroup>
<optgroup label="Pawn Attack">
    <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/pawn-attack/tough-crowd-work-1.mp3">Tough Crowd Work 1</option>
    <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/pawn-attack/tough-crowd-work-2.mp3">Tough Crowd Work 2</option>
  </optgroup>
  <optgroup label="Hero Time">
    <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/hero-time/the-new-house-rises.mp3">The New House Rises</option>
    <option value="https://raw.githubusercontent.com/benwieler-commits/queerz-mc-app/main/music/hero-time/the-tide-turns.mp3">The Tide Turns</option>
  </optgroup>
</select>
<div class="player-controls">
<button class="control-btn" id="playBtn">Play</button>
<button class="control-btn" id="pauseBtn">Pause</button>
<button class="control-btn" id="stopBtn">Stop</button>
<button class="control-btn" id="loopBtn" title="Loop Current Track">üîÅ Loop</button>
<button class="control-btn" id="addToPlaylistBtn" title="Add to Playlist">‚ûï Playlist</button>
<input class="volume-slider" id="volumeSlider" max="100" min="0" type="range" value="70"/>
<span class="volume-label" id="volumeLabel">70%</span>
</div>
<div class="now-playing" id="nowPlaying">No track playing</div>
<div class="playlist" id="playlist" style="margin-top: 10px; display: none;">
<strong>Playlist:</strong>
<div id="playlistTracks" style="margin-top: 5px;"></div>
</div>
<audio id="audioPlayer"></audio>
</div>
<!-- DICE ROLLER -->
<div class="dice-roller">
<h4>Dice Roller</h4>
<div class="dice-controls">
<label for="powerModifier">Power Modifier:</label>
<input class="power-input" id="powerModifier" max="5" min="-5" type="number" value="0"/>
<button class="roll-btn" id="rollDiceBtn">Roll 2d6</button>
</div>
<div class="dice-display" id="diceDisplay">
<div class="dice-formula">
<span class="die1">?</span>
<span class="plus">+</span>
<span class="die2">?</span>
<span class="plus">+</span>
<span class="modifier">?</span>
<span class="equals">=</span>
<span class="total">?</span>
</div>
<div class="roll-result" id="rollResult"></div>
</div>
</div>
</footer>
<!-- SCRIPT PANEL (Toggle with S) -->
<aside class="side-panel script-panel hidden" id="scriptPanel">
<div class="panel-header-side">
<h3 id="scriptPanelTitle">Campaign Script - Chapter 1</h3>
<button class="close-panel-btn" id="closeScriptBtn">X</button>
</div>
<div class="panel-search">
<input class="search-input" id="scriptSearch" placeholder="Search script..." type="text"/>
</div>
<div class="panel-tabs">
<button class="tab-btn active" data-tab="overview">Overview</button>
<button class="tab-btn" data-tab="scene1">Scene 1</button>
<button class="tab-btn" data-tab="scene2">Scene 2</button>
<button class="tab-btn" data-tab="scene3">Scene 3</button>
<button class="tab-btn" data-tab="innerSpace">Inner Space</button>
<button class="tab-btn" data-tab="aftermath">Aftermath</button>
<button class="tab-btn" data-tab="scaling">Scaling</button>
</div>
<div class="panel-content" id="scriptContent">
<!-- Script content loads here -->
</div>
</aside>
<!-- MC MOVES PANEL (Toggle with M) -->
<aside class="side-panel mc-moves-panel hidden" id="mcMovesPanel">
<div class="panel-header-side">
<h3>MC Moves</h3>
<button class="close-panel-btn" id="closeMcMovesBtn">X</button>
</div>
<div class="panel-content" id="mcMovesContent">
<div class="moves-section">
<h4>Soft Moves</h4>
<div class="move-item">
<strong>Show signs of trouble</strong>
<p>Foreshadow danger or complications approaching</p>
</div>
<div class="move-item">
<strong>Offer an opportunity</strong>
<p>Present a chance with a cost or complication</p>
</div>
<div class="move-item">
<strong>Tell them the cost</strong>
<p>Make the price clear before they commit</p>
</div>
<div class="move-item">
<strong>Put someone in a spot</strong>
<p>Force a difficult decision or dilemma</p>
</div>
<div class="move-item">
<strong>Present Twisted Justice</strong>
<p>Show the villain's narrow-minded worldview</p>
</div>
</div>
<div class="moves-section">
<h4>Hard Moves (On 6- or ignored threat)</h4>
<div class="move-item">
<strong>Deal harm</strong>
<p>Inflict damage or consequences</p>
</div>
<div class="move-item">
<strong>Turn their move back on them</strong>
<p>Use their action against them</p>
</div>
<div class="move-item">
<strong>Separate them</strong>
<p>Split the party or isolate someone</p>
</div>
<div class="move-item">
<strong>Make a construct move</strong>
<p>Use villain's construct abilities</p>
</div>
<div class="move-item">
<strong>Take away their stuff</strong>
<p>Remove resources or advantages</p>
</div>
<div class="move-item">
<strong>Make them buy</strong>
<p>Force them to accept a cost immediately</p>
</div>
<div class="move-item">
<strong>Give a status</strong>
<p>Apply a negative condition (conforming, shaken, etc.)</p>
</div>
</div>
</div>
</aside>
<!-- CAMPAIGN SETTINGS MODAL -->
<div class="modal hidden" id="campaignSettingsModal">
<div class="modal-content">
<div class="modal-header">
<h2>Campaign Settings</h2>
<button class="close-modal-btn" id="closeCampaignSettingsBtn">X</button>
</div>
<div class="modal-body">
<h3>Story Outcomes</h3>
<p>Track major story decisions to affect future chapters:</p>
<div class="outcome-section">
<h4>Chapter 1: The Jester's Last Laugh</h4>
<p style="color: rgba(255,255,255,0.8); margin-bottom: 10px;">Select the outcome (affects Chapter 2 content):</p>
<label>
<input checked="" name="outcome-chapter1" onchange="setOutcome('chapter1', 'none')" type="radio" value="none"/>
                        No outcome yet / Haven't played Chapter 1
                    </label>
<br/>
<label>
<input name="outcome-chapter1" onchange="setOutcome('chapter1', 'redeemed')" type="radio" value="redeemed"/>
                        Danny was redeemed (saved from Ignorance - Success)
                    </label>
<br/>
<label>
<input name="outcome-chapter1" onchange="setOutcome('chapter1', 'partial')" type="radio" value="partial"/>
                        Danny partially reformed (escaped but affected - Partial Success)
                    </label>
<br/>
<label>
<input name="outcome-chapter1" onchange="setOutcome('chapter1', 'vendetta')" type="radio" value="vendetta"/>
                        Danny's vendetta continues (allied with Pierce - Failure)
                    </label>
</div>
<div class="outcome-section">
<h4>Future Chapters</h4>
<p style="color: rgba(255,255,255,0.6);">Outcome tracking for Chapters 2-5 will be added as you play through the campaign.</p>
</div>
<hr style="margin: 20px 0; border-color: rgba(255,255,255,0.2);"/>
<h3>Export Player Data</h3>
<p>Export character data to send to players for their companion apps:</p>
<div id="exportPlayersList" style="margin-top: 10px;">
<!-- Player export buttons will be added here dynamically -->
</div>
</div>
</div>
</div>
<!-- SESSION MANAGEMENT MODAL -->
<div class="modal hidden" id="sessionMgmtModal">
<div class="modal-content">
<div class="modal-header">
<h2>Session Management</h2>
<button class="close-modal-btn" id="closeSessionMgmtBtn">X</button>
</div>
<div class="modal-body">
<h3>Current Session: <span id="currentSessionName">Default Session</span></h3>
<div style="margin: 20px 0;">
<button class="header-btn" onclick="saveSession()" style="margin: 5px;">üíæ Save Current Session</button>
<button class="header-btn" onclick="saveSessionAs()" style="margin: 5px;">üìù Save As New Session</button>
</div>
<hr style="margin: 20px 0; border-color: rgba(255,255,255,0.2);"/>
<h3>Saved Sessions</h3>
<div id="sessionList" style="margin-top: 10px;">
<!-- Sessions will be listed here -->
</div>
</div>
</div>
</div>
<!-- PLAYER OVERVIEW MODAL -->
<div class="modal hidden" id="playerOverviewModal">
<div class="modal-content large-modal">
<div class="modal-header">
<h2>Player Overview & Tag Management</h2>
<button class="close-modal-btn" id="closePlayerOverviewBtn">X</button>
</div>
<div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
<div id="playerOverviewContent">
<!-- Player cards will be rendered here -->
</div>
</div>
</div>
</div>
<!-- PLAYER NAME INPUT MODAL -->
<div class="modal hidden" id="playerModal">
<div class="modal-content">
<h3>Add Player to Spotlight</h3>
<p>Select an existing character or enter a name:</p>
<select class="styled-select" id="playerCharSelect">
<option value="">-- Select Character --</option>
</select>
<p style="text-align: center; margin: 10px 0;">- OR -</p>
<input class="text-input" id="playerNameInput" name="playerName" placeholder="Enter player name..." type="text"/>
<div class="modal-buttons">
<button class="btn-primary" id="confirmPlayerBtn">Add to Spotlight</button>
<button class="btn-secondary" id="cancelPlayerBtn">Cancel</button>
</div>
</div>
</div>
<!-- Firebase (compat CDN to avoid ES module issues on GitHub Pages) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<!-- Firebase Scripts with Module Support -->
<script type="module" src="firebase-config.js"></script>
<script type="module" src="firebase-broadcast.js"></script>

<!-- Your Existing App Script (NO MODULE) -->
<script src="app.js"></script>

<!-- Broadcast Button Handler (NEW) -->
<script type="module">
import { broadcast } from './firebase-broadcast.js';

document.addEventListener('DOMContentLoaded', function() {
    const broadcastBtn = document.getElementById('broadcastBtn');
    
    if (broadcastBtn) {
        broadcastBtn.addEventListener('click', async function() {
            console.log('üî• Broadcasting to players...');
            
            const locationSelect = document.getElementById('locationSelect');
            const characterSelect = document.getElementById('characterSelect');
            const trackSelect = document.getElementById('trackSelect');
            
            const payload = {
                currentScene: {
                    name: locationSelect?.options[locationSelect.selectedIndex]?.textContent || 'No scene',
                    imageUrl: locationSelect?.options[locationSelect.selectedIndex]?.dataset?.img || ''
                },
                currentMusic: {
                    name: trackSelect?.options[trackSelect.selectedIndex]?.textContent || 'No music',
                    url: trackSelect?.value || ''
                },
                activeCharacter: {
                    name: characterSelect?.options[characterSelect.selectedIndex]?.textContent || 'No character',
                    imageUrl: characterSelect?.options[characterSelect.selectedIndex]?.dataset?.img || ''
                }
            };
            
            console.log('üì° Scene:', payload.currentScene.name);
            console.log('üéµ Music:', payload.currentMusic.name);
            console.log('üë§ Character:', payload.activeCharacter.name);
            
            try {
                await broadcast(payload);
                console.log('‚úÖ Broadcast successful!');
                broadcastBtn.textContent = '‚úÖ Sent!';
                setTimeout(() => { broadcastBtn.textContent = 'üì° Broadcast'; }, 1000);
            } catch (error) {
                console.error('‚ùå Broadcast failed:', error);
                alert('Broadcast failed: ' + error.message);
            }
        });
        
        console.log('‚úÖ Broadcast button wired up');
    } else {
        console.warn('‚ö†Ô∏è Broadcast button not found');
    }
});
</script>

<!-- Image Display Handler (MUST come first) -->
<script>
// Image display for location and character selectors
document.addEventListener('DOMContentLoaded', function(){
  const locSel = document.getElementById('locationSelect');
  const charSel = document.getElementById('characterSelect');
  const sceneBox = document.getElementById('sceneDisplay');
  const charBox  = document.getElementById('characterDisplay');
  const audio = document.getElementById('audioPlayer');

  function setBoxImage(box, url, alt){
    if(!box) return;
    if(!url){ 
      box.innerHTML = '<div class="placeholder-text">Select a location to display</div>'; 
      return; 
    }
    box.innerHTML = '<img src="'+url+'" alt="'+(alt||'')+'" class="fit-cover" style="width: 100%; height: 100%; object-fit: cover;">';
  }

  if(locSel){
    locSel.addEventListener('change', function(){
      const opt = locSel.options[locSel.selectedIndex];
      const url = opt && opt.dataset && opt.dataset.img;
      if(url) setBoxImage(sceneBox, url, opt.textContent.trim());
    });
    console.log('‚úÖ Location selector initialized');
  }
  
  if(charSel){
    charSel.addEventListener('change', function(){
      const opt = charSel.options[charSel.selectedIndex];
      const url = opt && opt.dataset && opt.dataset.img;
      if(url) setBoxImage(charBox, url, opt.textContent.trim());
    });
    console.log('‚úÖ Character selector initialized');
  }
  
  const trackSel = document.getElementById('trackSelect');
  if(trackSel && audio){
    trackSel.addEventListener('change', function(){
      const opt = trackSel.options[trackSel.selectedIndex];
      if(opt && opt.value) { 
        audio.src = opt.value;
        console.log('üéµ Audio track changed:', opt.textContent);
      }
    });
    console.log('‚úÖ Music selector initialized');
  }
});
</script>

<!-- Broadcast Button Handler -->
<script type="module">
import { broadcast } from './firebase-broadcast.js';

document.addEventListener('DOMContentLoaded', function() {
    console.log('üî• Initializing broadcast functionality...');
    
    const broadcastBtn = document.getElementById('broadcastBtn');
    
    if (!broadcastBtn) {
        console.warn('‚ö†Ô∏è Broadcast button not found - looking for element with id="broadcastBtn"');
        return;
    }
    
    broadcastBtn.addEventListener('click', async function() {
        console.log('üì° Broadcast button clicked');
        
        // Get current selections
        const locationSelect = document.getElementById('locationSelect');
        const characterSelect = document.getElementById('characterSelect');
        const trackSelect = document.getElementById('trackSelect');
        
        // Build payload with current selections
        const payload = {
            currentScene: {
                name: 'No scene selected',
                imageUrl: ''
            },
            currentMusic: {
                name: 'No music playing',
                url: ''
            },
            activeCharacter: {
                name: 'No character',
                imageUrl: ''
            },
            timestamp: Date.now()
        };
        
        // Get scene info
        if (locationSelect && locationSelect.selectedIndex > 0) {
            const opt = locationSelect.options[locationSelect.selectedIndex];
            payload.currentScene.name = opt.textContent.trim();
            payload.currentScene.imageUrl = opt.dataset.img || '';
            console.log('üìç Scene:', payload.currentScene.name);
        }
        
        // Get music info with playlist and loop settings
        if (trackSelect && trackSelect.selectedIndex > 0) {
            const opt = trackSelect.options[trackSelect.selectedIndex];
            payload.currentMusic.name = opt.textContent.trim();
            payload.currentMusic.url = opt.value || '';

            // Include loop setting
            const loopBtn = document.getElementById('loopBtn');
            payload.currentMusic.isLooping = loopBtn ? loopBtn.classList.contains('active') : false;

            // Include playlist if it exists
            const playlistTracksDiv = document.getElementById('playlistTracks');
            if (playlistTracksDiv && playlistTracksDiv.children.length > 0) {
                payload.currentMusic.playlist = [];
                Array.from(playlistTracksDiv.children).forEach(item => {
                    const trackName = item.textContent.replace('‚ñ∂ ', '').replace('üóëÔ∏è', '').trim();
                    const trackUrl = item.dataset.url;
                    if (trackUrl) {
                        payload.currentMusic.playlist.push({ name: trackName, url: trackUrl });
                    }
                });
            }

            console.log('üéµ Music:', payload.currentMusic.name, 'Loop:', payload.currentMusic.isLooping);
        }
        
        // Get character info
        if (characterSelect && characterSelect.selectedIndex > 0) {
            const opt = characterSelect.options[characterSelect.selectedIndex];
            payload.activeCharacter.name = opt.textContent.trim();
            payload.activeCharacter.imageUrl = opt.dataset.img || '';
            console.log('üë§ Character:', payload.activeCharacter.name);
        }
        
        // Send broadcast
        try {
            console.log('üöÄ Sending broadcast...');
            await broadcast(payload);
            console.log('‚úÖ Broadcast successful!');
            
            // Visual feedback
            const originalText = broadcastBtn.textContent;
            broadcastBtn.textContent = '‚úÖ Sent!';
            broadcastBtn.style.background = '#4CAF50';
            
            setTimeout(() => {
                broadcastBtn.textContent = originalText;
                broadcastBtn.style.background = '';
            }, 1500);
            
        } catch (error) {
            console.error('‚ùå Broadcast failed:', error);
            alert('Failed to broadcast: ' + error.message + '\n\nCheck Firebase database rules.');
        }
    });
    
    console.log('‚úÖ Broadcast button initialized');
});
</script>

</body>
</html>
